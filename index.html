<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8" />
<title>Collision Graph – PLC vs Robot Programs</title>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
html, body {
  height:100%;
  margin:0;
  font-family: Arial, sans-serif;
}

#container {
  width:1200px;
  height:600px;
  overflow:auto;
  position:relative;
  background:#f3f3f3;
}

/* ===================== CONTROLS ===================== */
.controls {
  position: fixed;
  top:10px;
  right:12px;
  background: rgba(255,255,255,0.95);
  border:1px solid #ccc;
  padding:8px;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,0.12);
  z-index:9999;
}

.controls input[type=file],
.controls button {
  margin:4px 0;
  width:250px;
  display:block;
}

.controls .mode {
  margin-top:6px;
  font-size:13px;
  color:#333;
}

/* ===================== SVG ===================== */
svg {
  display:block;
  background: transparent;
}

/* ===================== ROBOT NODES ===================== */
.node rect {
  fill:#ffffff;
  stroke:#ff0000;
  stroke-width:2px;
  cursor:grab;
}

.node text {
  fill:#000000;
  font-size:12px;
  pointer-events:none;
  text-anchor:middle;
  dominant-baseline:middle;
}

/* ===================== LINKS / COLLISIONS ===================== */
.link {
  stroke:red;
  stroke-width:4px;
  fill:none;
  pointer-events:none;
}

.collision circle {
  stroke:#111;
  cursor:pointer;
}

.collision text {
  font-size:12px;
  fill:black;
  pointer-events:none;
  text-anchor:middle;
  dominant-baseline:middle;
}

/* ===================== TOOLTIP ===================== */
#tooltip {
  position:absolute;
  display:none;
  background: rgba(255,255,240,0.98);
  border:1px solid #999;
  padding:8px;
  border-radius:6px;
  max-width:360px;
  white-space:pre-line;
  z-index:10000;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}

/* ===================== LEGEND ===================== */
.legend {
  font-size:12px;
  margin-top:6px;
}

.legend .dot {
  width:12px;
  height:12px;
  display:inline-block;
  vertical-align:middle;
  margin-right:6px;
  border:1px solid #111;
}

/* ===================== ROBOT CHECKLIST ===================== */
#robotList label {
  display:flex;
  align-items:center;
  gap:8px;
  margin:2px 0;
  cursor:pointer;
}
#robotList input {
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===================== CONTROLS ===================== -->
<div class="controls">

  Import PLC
  <input id="plcFile" type="file" accept=".xlsx,.xls,.csv">

  Import Robot Programs
  <input id="progFile" type="file" accept=".xlsx,.xls,.csv">

  Import Layout Image
  <input id="bgUpload" type="file" accept="image/*">

  <button id="zoomImageBtn">Zoom Image Mode</button>
  <button id="zoomGraphBtn">Zoom Graph Mode</button>
  <button id="exportSvgBtn">Export to SVG</button>
  <button id="saveProjectBtn">Save Graph</button>

  <input id="loadProjectInput" type="file" accept=".json" style="display:none">
  <button id="loadProjectBtn">Load Graph</button>

  <div class="mode">
    <small>Current mode: <span id="modeLabel">Graph</span></small>
  </div>

  <div class="legend">
    <div><span class="dot" style="background:#ffffff"></span> Collision implemented & used (mutual)</div>
    <div><span class="dot" style="background:#ffcccc"></span> Collision implemented but NOT used</div>
    <div><span class="dot" style="background:#ff6666"></span> Collision implemented in only one direction (PLC error)</div>
    <div><span class="dot" style="background:#fff7cc"></span> Collision used in programs but missing in PLC</div>
  </div>

  <hr style="margin:10px 0;">

  <div style="font-size:13px; margin-bottom:6px;">
    <b>Robots</b> (uncheck to hide)
  </div>

  <div id="robotList"
       style="max-height:220px; overflow:auto;
              border:1px solid #ccc;
              border-radius:6px;
              padding:6px;
              background:#fff;">
  </div>

  <div style="margin-top:6px; display:flex; gap:6px;">
    <button id="robotsAllBtn" style="width:122px;">Show All</button>
    <button id="robotsNoneBtn" style="width:122px;">Hide All</button>
  </div>

</div>

<!-- ===================== GRAPH ===================== -->
<div id="container">
  <svg id="svg" width="1200" height="600"></svg>
</div>

<div id="tooltip"></div>

<script>
/* ============================================================
   INITIAL SETUP
============================================================ */
const svgEl = d3.select("#svg");
const svgWidth = 1200, svgHeight = 600;
const tooltip = d3.select("#tooltip");
const modeLabel = d3.select("#modeLabel");

const rootG = svgEl.append("g");
const bgGroup = rootG.append("g");
const graphGroup = rootG.append("g");
const linkGroup = graphGroup.append("g");
const collisionGroup = graphGroup.append("g");
const nodeGroup = graphGroup.append("g");

/* ============================================================
   CONTEXT MENU – DELETE ROBOT
============================================================ */
let contextRobot = null;

const contextMenu = d3.select("body").append("div")
  .attr("id","contextMenu")
  .style("position","absolute")
  .style("display","none")
  .style("background","white")
  .style("border","1px solid #888")
  .style("border-radius","5px")
  .style("padding","6px")
  .style("z-index","99999")
  .style("font-size","13px")
  .text("Delete Robot");

contextMenu.on("click", () => {
  if (contextRobot) deleteRobot(contextRobot.id);
  contextRobot = null;
  hideContextMenu();
});

d3.select("body").on("click", hideContextMenu);

function showContextMenu(event, d){
  contextRobot = d;
  contextMenu
    .style("left", event.pageX + "px")
    .style("top", event.pageY + "px")
    .style("display","block");
  event.preventDefault();
}
function hideContextMenu(){
  contextMenu.style("display","none");
}

/* ============================================================
   DATA STRUCTURES
============================================================ */
let plcData=[], progData=[], allCollisions=[], nodes=[];
let plcSet=new Set(), progSet=new Set(), programsByKey=new Map();
let hiddenRobots=new Set();
const nodeHeight=28;

/* ============================================================
   HELPERS
============================================================ */
function keyFor(a,b,n){ return `${a}__${b}__${n}`; }
function sortedPair(a,b){ return [a,b].sort(); }
function isRobotHidden(id){ return hiddenRobots.has(id); }
function findNodeById(id){ return nodes.find(n=>n.id===id); }

/* ============================================================
   FILE PARSER
============================================================ */
function parseFileAsJSON(file, callback){
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:'binary'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    callback(XLSX.utils.sheet_to_json(sheet,{defval:""}));
  };
  reader.readAsBinaryString(file);
}

/* ============================================================
   IMPORT PLC
============================================================ */
document.getElementById("plcFile").addEventListener("change",function(){
  if(!this.files[0]) return;
  parseFileAsJSON(this.files[0], rows=>{
    plcData = rows.map(r=>({
      robot1:(r.Robot1||"").trim(),
      robot2:(r.Robot2||"").trim(),
      number:r.CollisionNumber||r.number
    }));
    rebuild();
  });
});

/* ============================================================
   IMPORT PROGRAMS
============================================================ */
document.getElementById("progFile").addEventListener("change",function(){
  if(!this.files[0]) return;
  parseFileAsJSON(this.files[0], rows=>{
    progData = rows.map(r=>({
      robot:(r.Robot||"").trim(),
      robot2:(r.Robot2||"").trim(),
      number:r.CollisionNumber||r.number,
      program:(r.Program||"").trim()
    }));
    rebuild();
  });
});

/* ============================================================
   BUILD DATA
============================================================ */
function rebuild(){
  plcSet.clear(); progSet.clear(); programsByKey.clear();

  plcData.forEach(r=>{
    if(r.robot1&&r.robot2&&r.number)
      plcSet.add(keyFor(r.robot1,r.robot2,r.number));
  });

  progData.forEach(r=>{
    if(r.robot&&r.robot2&&r.number){
      const k=keyFor(r.robot,r.robot2,r.number);
      progSet.add(k);
      if(!programsByKey.has(k)) programsByKey.set(k,[]);
      programsByKey.get(k).push(r.program);
    }
  });

  const map=new Map();
  [...plcSet,...progSet].forEach(k=>{
    const [a,b,n]=k.split("__");
    const [sa,sb]=sortedPair(a,b);
    const mk=`${sa}__${sb}__${n}`;
    if(!map.has(mk)){
      const k1=keyFor(sa,sb,n), k2=keyFor(sb,sa,n);
      map.set(mk,{
        key:mk, robot1:sa, robot2:sb, number:n,
        missingInPLC:(progSet.has(k1)&&!plcSet.has(k1))||(progSet.has(k2)&&!plcSet.has(k2)),
        plcMutual:plcSet.has(k1)&&plcSet.has(k2),
        usedBoth:progSet.has(k1)&&progSet.has(k2),
        programs_robot1:programsByKey.get(k1)||[],
        programs_robot2:programsByKey.get(k2)||[]
      });
    }
  });

  allCollisions=[...map.values()];
  nodes=[...new Set(allCollisions.flatMap(c=>[c.robot1,c.robot2]))]
    .map(id=>({id,x:Math.random()*900+100,y:Math.random()*400+100}));

  hiddenRobots.clear();
  initGraph();
}

/* ============================================================
   GRAPH RENDER
============================================================ */
let nodeSel, linkSel, collSel;

function initGraph(){
  linkGroup.selectAll("*").remove();
  collisionGroup.selectAll("*").remove();
  nodeGroup.selectAll("*").remove();

  const linkMap=new Map();
  allCollisions.forEach(c=>{
    const k=sortedPair(c.robot1,c.robot2).join("__");
    if(!linkMap.has(k)) linkMap.set(k,{source:c.robot1,target:c.robot2,collisions:[]});
    linkMap.get(k).collisions.push(c);
  });

  const links=[...linkMap.values()];

  linkSel=linkGroup.selectAll("line")
    .data(links).enter().append("line").attr("class","link");

  const flat=[];
  links.forEach(l=>l.collisions.forEach((c,i)=>flat.push({collision:c,link:l,index:i})));

  collSel=collisionGroup.selectAll("g")
    .data(flat).enter().append("g").attr("class","collision")
    .each(function(d){
      const g=d3.select(this);
      let fill="#ffffff";
      if(d.collision.missingInPLC) fill="#fff7cc";
      else if(!d.collision.plcMutual) fill="#ff6666";
      else if(!d.collision.usedBoth) fill="#ffcccc";
      g.append("circle").attr("r",12).style("fill",fill)
        .on("click",(e)=>{e.stopPropagation();showTooltip(d,e);});
      g.append("text").attr("dy","0.35em").text(d.collision.number);
    });

  nodeSel=nodeGroup.selectAll("g")
    .data(nodes).enter().append("g").attr("class","node")
    .on("contextmenu",(e,d)=>showContextMenu(e,d))
    .call(d3.drag().on("drag",(e,d)=>{d.x=e.x;d.y=e.y;update();}));

  nodeSel.append("rect").attr("rx",6).attr("ry",6);
  nodeSel.append("text").text(d=>d.id);

  renderRobotList();
  update();
}

/* ============================================================
   UPDATE POSITIONS
============================================================ */
function update(){
  nodeSel.each(function(d){
    const w=Math.max(60,d.id.length*8+20);
    d.width=w; d.height=nodeHeight;
    const g=d3.select(this);
    g.attr("transform",`translate(${d.x},${d.y})`);
    g.select("rect").attr("width",w).attr("height",d.height);
    g.select("text").attr("x",w/2).attr("y",d.height/2);
  });

  linkSel.each(function(d){
    const s=findNodeById(d.source), t=findNodeById(d.target);
    if(!s||!t) return;
    d3.select(this)
      .attr("x1",s.x+s.width/2).attr("y1",s.y+s.height/2)
      .attr("x2",t.x+t.width/2).attr("y2",t.y+t.height/2);
  });

  collSel.each(function(d){
    const s=findNodeById(d.link.source), t=findNodeById(d.link.target);
    if(!s||!t) return;
    const cx=(s.x+t.x)/2, cy=(s.y+t.y)/2;
    d3.select(this).select("circle").attr("cx",cx).attr("cy",cy);
    d3.select(this).select("text").attr("x",cx).attr("y",cy);
  });

  applyVisibility();
}

/* ============================================================
   VISIBILITY
============================================================ */
function renderRobotList(){
  const div=document.getElementById("robotList");
  div.innerHTML="";
  nodes.map(n=>n.id).sort().forEach(id=>{
    const l=document.createElement("label");
    const c=document.createElement("input");
    c.type="checkbox"; c.checked=!hiddenRobots.has(id);
    c.onchange=()=>{c.checked?hiddenRobots.delete(id):hiddenRobots.add(id);applyVisibility();};
    l.append(c,document.createTextNode(id));
    div.append(l);
  });
}

function applyVisibility(){
  nodeSel.style("display",d=>hiddenRobots.has(d.id)?"none":null);
  linkSel.style("display",d=>(hiddenRobots.has(d.source)||hiddenRobots.has(d.target))?"none":null);
  collSel.style("display",d=>(hiddenRobots.has(d.collision.robot1)||hiddenRobots.has(d.collision.robot2))?"none":null);
  tooltip.style("display","none");
}

document.getElementById("robotsAllBtn").onclick=()=>{hiddenRobots.clear();renderRobotList();applyVisibility();};
document.getElementById("robotsNoneBtn").onclick=()=>{hiddenRobots=new Set(nodes.map(n=>n.id));renderRobotList();applyVisibility();};

/* ============================================================
   TOOLTIP
============================================================ */
function showTooltip(d,e){
  tooltip.style("display","block")
    .html(`<b>Collision ${d.collision.number}</b>\n\n<b>${d.collision.robot1}</b>\n${d.collision.programs_robot1.join("\n")}\n\n<b>${d.collision.robot2}</b>\n${d.collision.programs_robot2.join("\n")}`)
    .style("left",(e.pageX+12)+"px")
    .style("top",(e.pageY+12)+"px");
}

svgEl.on("click",()=>tooltip.style("display","none"));
</script>

</body>
</html>
